<script>
  window.onerror = function(message, source, lineno, colno, error) {
  alert("ERROR: " + message + " | Línea: " + lineno);
};
/* ================= CONFIG ================= */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbyOde3SksOR_CMmSDNrA7F-5ptCO78M7yr7dxG5Usty8E0hu6kE93PbSuTao0OeXsx-/exec";
const SHARED_SECRET = "demo123";

const PRECIO_ADULTO = 35;
const PRECIO_NINO = 12.50;

/* ================= OPCIONES ================= */
const FUNCIONES = [
  "Función 1","Función 2","Función 3","Función 4",
  "Función 5","Función 6","Función 7","Función 8"
];

const HORAS = [
  "5:30 PM","6:00 PM","6:30 PM","7:00 PM",
  "7:30 PM","8:00 PM","8:30 PM","9:00 PM"
];

const MENU = {
  aperitivos:["Arancini","Montaditos de Guiso"],
  principales:["Pasta Vegana","Risotto de Calabaza","Rigatoni Salsa Setas"],
  postres:["Dulce de Papaya","Flan Tiramisu"],
  ninos:["Tenders","Mac and Cheese"]
};

const MAX_GUESTS = 8;

/* ================= HELPERS ================= */
const $ = id => document.getElementById(id);

function fillSelect(el, arr){
  el.innerHTML="";
  arr.forEach(v=>{
    const o=document.createElement("option");
    o.value=v;
    o.textContent=v;
    el.appendChild(o);
  });
}

function toast(type,msg,extra){
  const t=$("toast");
  t.className="toast "+type;
  t.style.display="block";
  t.innerHTML=msg+(extra?`<div class="mono">${extra}</div>`:"");
}

/* ================= HORAS DISPONIBLES ================= */
async function cargarHorasDisponibles(){
  const sel = $("hora");
  sel.innerHTML = "";

  for(const hora of HORAS){
    try {

      const res = await fetch(BACKEND_URL,{
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8"},
        body:JSON.stringify({
          action:"availability",
          hora,
          funcion:$("funcion").value,
          secret:SHARED_SECRET
        })
      });

      if(!res.ok) continue;

      const data = await res.json();
      const disponibles = data?.disponibles ?? 0;

      if(!data.full){
        const opt=document.createElement("option");
        opt.value=hora;
        opt.textContent=`${hora} (${disponibles} disponibles)`;
        sel.appendChild(opt);
      }

    } catch(err){
      console.log("Error disponibilidad:", err);
    }
  }
}
/* ================= TOTAL ================= */
function actualizarTotal(){
  let total=0;
  document.querySelectorAll(".tipoPersona").forEach(sel=>{
    total+=sel.value==="nino"?PRECIO_NINO:PRECIO_ADULTO;
  });
  if($("total")) $("total").textContent="$"+total.toFixed(2);
}

/* ================= GUEST BUILDER ================= */
let guestCount=0;

function guestTemplate(idx){
  const wrap=document.createElement("div");
  wrap.className="guest";

  wrap.innerHTML=`
  <div class="guestTop">
    <div class="guestLabel">Persona ${idx}</div>
    <button class="ghostBtn removeBtn">Eliminar</button>
  </div>

  <label>Nombre Persona</label>
  <input class="name" placeholder="Nombre">

  <label>Tipo Persona</label>
  <select class="tipoPersona">
    <option value="adulto">Adulto $35</option>
    <option value="nino">Niño $12.50</option>
  </select>

  <div class="menuAdulto">
    <label>Aperitivo</label>
    <select class="aperitivo"></select>

    <label>Principal</label>
    <select class="principal"></select>

    <label>Postre</label>
    <select class="postre"></select>
  </div>

  <div class="menuNino" style="display:none">
    <label>Menú Niño</label>
    <select class="principalNino"></select>
  </div>
  `;

  fillSelect(wrap.querySelector(".aperitivo"),MENU.aperitivos);
  fillSelect(wrap.querySelector(".principal"),MENU.principales);
  fillSelect(wrap.querySelector(".postre"),MENU.postres);
  fillSelect(wrap.querySelector(".principalNino"),MENU.ninos);

  wrap.querySelector(".removeBtn").onclick=()=>{
    wrap.remove();
    guestCount--;
    actualizarTotal();
  };

  wrap.querySelector(".tipoPersona").onchange=e=>{
    const adulto=wrap.querySelector(".menuAdulto");
    const nino=wrap.querySelector(".menuNino");

    if(e.target.value==="nino"){
      adulto.style.display="none";
      nino.style.display="block";
    }else{
      adulto.style.display="block";
      nino.style.display="none";
    }
    actualizarTotal();
  };

  return wrap;
}

function addGuest(){
  if(guestCount>=MAX_GUESTS) return;
  guestCount++;
  $("guests").appendChild(guestTemplate(guestCount));
  actualizarTotal();
}

/* ================= PAYLOAD ================= */
function getGuests(){
  return Array.from(document.querySelectorAll(".guest")).map(g=>{
    const tipo=g.querySelector(".tipoPersona").value;

    if(tipo==="nino"){
      return{
        name:g.querySelector(".name").value,
        aperitivo:"",
        principal:g.querySelector(".principalNino").value,
        postre:""
      };
    }

    return{
      name:g.querySelector(".name").value,
      aperitivo:g.querySelector(".aperitivo").value,
      principal:g.querySelector(".principal").value,
      postre:g.querySelector(".postre").value
    };
  });
}

/* ================= SUBMIT ================= */
async function submitReservation(){

  const payload={
    secret:SHARED_SECRET,
    action:"create",
    cliente:$("cliente").value,
    phone:$("telefono").value,
    funcion:$("funcion").value,
    hora:$("hora").value,
    guests:getGuests(),
    notas:$("notas").value||""
  };

  try{
    const res=await fetch(BACKEND_URL,{
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8"},
      body:JSON.stringify(payload)
    });

    const data=await res.json();

    if(data.ok){
      toast("ok","Reservación confirmada",
        `ID: ${data.reservation_id}`
      );
    }else if(data.full){
      toast("warn","Hora llena",
        `Reservado: ${data.yaReservado}`
      );
    }else{
      toast("err","Error",data.error);
    }

  }catch(e){
    toast("err","Error conexión",e);
  }
}

/* ================= INIT ================= */
/* ================= INIT ================= */
document.addEventListener("DOMContentLoaded", function(){

  if(!$("funcion")) return console.error("Falta #funcion");
  if(!$("hora")) return console.error("Falta #hora");
  if(!$("guests")) return console.error("Falta #guests");
  if(!$("addGuestBtn")) return console.error("Falta #addGuestBtn");
  if(!$("submitBtn")) return console.error("Falta #submitBtn");

  fillSelect($("funcion"), FUNCIONES);

  $("funcion").addEventListener("change", cargarHorasDisponibles);

  cargarHorasDisponibles();

  $("addGuestBtn").onclick = addGuest;
  $("submitBtn").onclick = submitReservation;

  addGuest();
});
</script>
